# =============================================================================
# MOXD BUILD & PUBLISH WORKFLOW
# =============================================================================
#
# FEATURES:
#   ✅ Cake Build Script - Professional build automation
#   ✅ Matrix OS - Can run on multiple operating systems
#   ✅ DocFX Documentation - Auto-generated API docs deployed to GitHub Pages
#   ✅ GitHub Packages - Publishes pre-release packages for testing
#   ✅ NuGet.org - Publishes release packages
#   ✅ MinVer - Auto-versioning from Git tags
#
# TRIGGERS:
#   - Push to master     → Build, Test, Pack, Push to GitHub Packages
#   - Pull request       → Build, Test, Pack
#   - Release published  → Build, Test, Pack, Push to NuGet.org
#   - Manual trigger     → Build, Test, Pack
#
# HOW TO RELEASE:
#   1. git tag v1.0.0
#   2. git push origin v1.0.0
#   3. Go to GitHub → Releases → Create release from tag
#   4. Publish release → Workflow publishes to NuGet.org
#
# =============================================================================

name: Build

# -----------------------------------------------------------------------------
# TRIGGERS
# -----------------------------------------------------------------------------
on:
  push:
    branches:
      - master

  pull_request:
    branches:
      - master

  release:
    types:
      - published

  workflow_dispatch:

# -----------------------------------------------------------------------------
# ENVIRONMENT VARIABLES
# -----------------------------------------------------------------------------
env:
  DOTNET_SKIP_FIRST_TIME_EXPERIENCE: true
  DOTNET_CLI_TELEMETRY_OPTOUT: true
  DOTNET_NOLOGO: true
  MINVERBUILDMETADATA: build.${{ github.run_number }}

# -----------------------------------------------------------------------------
# JOBS
# -----------------------------------------------------------------------------
jobs:

  # ===========================================================================
  # JOB 1: BUILD
  # ===========================================================================
  build:
    name: Build-${{ matrix.os }}
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          lfs: true

      - name: Setup Java JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            8.0.x
            9.0.x

      - name: Install MAUI workload
        run: dotnet workload install maui

      - name: Restore .NET tools
        run: dotnet tool restore

      - name: Build
        run: dotnet cake --target=Build
        shell: pwsh

      - name: Pack
        run: dotnet cake --target=Pack
        shell: pwsh

      - name: Build Documentation - Metadata
        run: dotnet docfx metadata docfx.json
        shell: pwsh

      - name: Build Documentation - Site
        run: dotnet docfx build docfx.json
        shell: pwsh

      - name: Upload NuGet packages
        uses: actions/upload-artifact@v4
        with:
          name: nuget-packages-${{ matrix.os }}
          path: ./Artifacts/*.nupkg
          retention-days: 30

      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: docfx-site
          path: ./_site
          retention-days: 30

      - name: Upload Build Logs
        uses: actions/upload-artifact@v4
        with:
          name: binlog-${{ matrix.os }}
          path: ./Binlog
          retention-days: 7

  # ===========================================================================
  # JOB 2: PUSH TO GITHUB PACKAGES
  # ===========================================================================
  push-github-packages:
    name: Push to GitHub Packages
    needs: build
    
    if: github.ref == 'refs/heads/master' || github.event_name == 'release'
    
    runs-on: windows-latest

    environment:
      name: GitHub Packages
      url: https://github.com/moxd-dev/Moxd/packages

    permissions:
      packages: write
      contents: read

    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages-windows-latest
          path: ./packages

      - name: Add GitHub Packages source
        run: |
          dotnet nuget add source https://nuget.pkg.github.com/moxd-dev/index.json `
            --name GitHub `
            --username moxd-dev `
            --password ${{ secrets.GITHUB_TOKEN }}
        shell: pwsh

      - name: Push to GitHub Packages
        run: |
          dotnet nuget push ./packages/*.nupkg `
            --api-key ${{ secrets.GITHUB_TOKEN }} `
            --source GitHub `
            --skip-duplicate
        shell: pwsh

  # ===========================================================================
  # JOB 3: PUSH TO NUGET.ORG
  # ===========================================================================
  push-nuget:
    name: Push to NuGet.org
    needs: build

    if: github.event_name == 'release'

    runs-on: ubuntu-latest

    environment:
      name: NuGet
      url: https://www.nuget.org/packages/Moxd

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Download NuGet packages
        uses: actions/download-artifact@v4
        with:
          name: nuget-packages-windows-latest
          path: ./packages

      - name: Setup .NET SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 8.0.x

      - name: NuGet Login (OIDC)
        uses: nuget/login@v1
        with:
          user: ${{ secrets.NUGET_USER }}

      - name: Push to NuGet.org
        run: |
          for package in ./packages/*.nupkg; do
            if [[ ! "$package" == *"preview"* ]] && [[ ! "$package" == *"alpha"* ]] && [[ ! "$package" == *"beta"* ]]; then
              echo "Publishing: $package"
              dotnet nuget push "$package" \
                --source https://api.nuget.org/v3/index.json \
                --skip-duplicate
            else
              echo "Skipping pre-release: $package"
            fi
          done
        shell: bash

  # ===========================================================================
  # JOB 4: DEPLOY DOCUMENTATION TO GITHUB PAGES
  # ===========================================================================
  deploy-docs:
    name: Deploy Documentation
    needs: build

    if: github.ref == 'refs/heads/master' && github.event_name == 'push'

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download Documentation
        uses: actions/download-artifact@v4
        with:
          name: docfx-site
          path: ./_site

      - name: Setup GitHub Pages
        uses: actions/configure-pages@v4

      - name: Upload to GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4